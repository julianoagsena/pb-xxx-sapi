<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd">
		<error-handler name="Global_Error_Handler">
        	<on-error-propagate type="APIKIT:BAD_REQUEST" doc:name="400">
                <ee:transform doc:name="Transform Message" doc:id="271c5998-3def-4a93-8608-41d3bb109c9b">
                    <ee:message>
                        <ee:set-payload><![CDATA[%dw 2.0
output json
---
{
	"code": 400,
	"correlation_id": correlationId,
	"reason": error.errorType.asString,
	"detail": error.description
}]]></ee:set-payload>
                    </ee:message>
                    <ee:variables />
                </ee:transform>
                <set-variable value="400" doc:name="httpStatus" doc:id="457ac7f4-c6d6-475c-8b53-d411aaa8588c" variableName="httpStatus" />
                <ee:transform doc:name="Log" doc:id="8bfa94d6-de65-4e6a-8f03-f778987c4a57">
                    <ee:message />
                    <ee:variables>
                        <ee:set-variable variableName="log"><![CDATA[%dw 2.0
output json
---
{
	"Endpoint": vars.attributes.requestPath,
	"Request_payload": vars.payload,
	"Response_payload": payload
}]]></ee:set-variable>
                    </ee:variables>
                </ee:transform>
                <logger level="ERROR" doc:name="Logger" doc:id="69e1521c-674a-4560-88be-c51510193a28" message="#[%dw 2.0&#xA;output java&#xA;---&#xA;'&#xA;Trace Point - Error 500&#xA;'&#xA;++&#xA;write(vars.log,'application/json')]" />
            </on-error-propagate>
            <on-error-propagate type="APIKIT:NOT_FOUND" doc:name="404">
                <ee:transform doc:name="Transform Message" doc:id="1d985513-9799-4746-9b0d-350ab2919868">
                    <ee:message>
                        <ee:set-payload><![CDATA[%dw 2.0
output json
---
{
	"code": 404,
	"correlation_id": correlationId,
	"reason": error.errorType.asString,
	"detail": error.description
}]]></ee:set-payload>
                    </ee:message>
                    <ee:variables />
                </ee:transform>
                <set-variable value="404" doc:name="httpStatus" doc:id="bfc64457-1ebf-435b-bc8d-bd3429c90e1d" variableName="httpStatus" />
                <ee:transform doc:name="Log" doc:id="3ec9de43-0a1a-49df-85e6-1fdc1d488ad9">
                    <ee:message />
                    <ee:variables>
                        <ee:set-variable variableName="log"><![CDATA[%dw 2.0
output json
---
{
	"Endpoint": vars.attributes.requestPath,
	"Request_payload": vars.payload,
	"Response_payload": payload
}]]></ee:set-variable>
                    </ee:variables>
                </ee:transform>
                <logger level="ERROR" doc:name="Logger" doc:id="314baabd-47a5-4aa0-af17-18c27d728d2b" message="#[%dw 2.0&#xA;output java&#xA;---&#xA;'&#xA;Trace Point - Error 500&#xA;'&#xA;++&#xA;write(vars.log,'application/json')]" />
            </on-error-propagate>
            <on-error-propagate type="APIKIT:METHOD_NOT_ALLOWED" doc:name="405">
                <ee:transform doc:name="Transform Message" doc:id="5a15a752-3b9f-4a75-a7b6-173bc83a5e8a">
                    <ee:message>
                        <ee:set-payload><![CDATA[%dw 2.0
output json
---
{
	"code": 405,
	"correlation_id": correlationId,
	"reason": error.errorType.asString,
	"detail": error.description
}]]></ee:set-payload>
                    </ee:message>
                    <ee:variables />
                </ee:transform>
                <set-variable value="405" doc:name="httpStatus" doc:id="0419a647-0196-4431-8172-a2a91900db64" variableName="httpStatus" />
                <ee:transform doc:name="Log" doc:id="76c1fb4d-1979-47d1-8038-feef608e2389">
                    <ee:message />
                    <ee:variables>
                        <ee:set-variable variableName="log"><![CDATA[%dw 2.0
output json
---
{
	"Endpoint": vars.attributes.requestPath,
	"Request_payload": vars.payload,
	"Response_payload": payload
}]]></ee:set-variable>
                    </ee:variables>
                </ee:transform>
                <logger level="ERROR" doc:name="Logger" doc:id="eef62ddd-3478-4939-b723-f14985bf3192" message="#[%dw 2.0&#xA;output java&#xA;---&#xA;'&#xA;Trace Point - Error 500&#xA;'&#xA;++&#xA;write(vars.log,'application/json')]" />
            </on-error-propagate>
            <on-error-propagate type="APIKIT:NOT_ACCEPTABLE" doc:name="406">
                <ee:transform doc:name="Transform Message" doc:id="b7c5a67e-a707-4d77-80ae-f40d2721b980">
                    <ee:message>
                        <ee:set-payload><![CDATA[%dw 2.0
output json
---
{
	"code": 406,
	"correlation_id": correlationId,
	"reason": error.errorType.asString,
	"detail": error.description
}]]></ee:set-payload>
                    </ee:message>
                    <ee:variables />
                </ee:transform>
                <set-variable value="406" doc:name="httpStatus" doc:id="77419806-b40f-402d-a55b-abf62dece07c" variableName="httpStatus" />
                <ee:transform doc:name="Log" doc:id="69f40439-a090-494a-8922-a2020d2ef3d5">
                    <ee:message />
                    <ee:variables>
                        <ee:set-variable variableName="log"><![CDATA[%dw 2.0
output json
---
{
	"Endpoint": vars.attributes.requestPath,
	"Request_payload": vars.payload,
	"Response_payload": payload
}]]></ee:set-variable>
                    </ee:variables>
                </ee:transform>
                <logger level="ERROR" doc:name="Logger" doc:id="0194bd37-b9b2-4b01-98cf-c52d7e940daf" message="#[%dw 2.0&#xA;output java&#xA;---&#xA;'&#xA;Trace Point - Error 500&#xA;'&#xA;++&#xA;write(vars.log,'application/json')]" />
            </on-error-propagate>
            <on-error-propagate type="APIKIT:UNSUPPORTED_MEDIA_TYPE" doc:name="415">
                <ee:transform doc:name="Transform Message" doc:id="96eefb0c-9e59-47fe-a686-6b486aebda7b">
                    <ee:message>
                        <ee:set-payload><![CDATA[%dw 2.0
output json
---
{
	"code": 415,
	"correlation_id": correlationId,
	"reason": error.errorType.asString,
	"detail": error.description
}]]></ee:set-payload>
                    </ee:message>
                    <ee:variables />
                </ee:transform>
                <set-variable value="415" doc:name="httpStatus" doc:id="2d7c1585-06d5-4ab2-bf3f-9b96b2c89378" variableName="httpStatus" />
                <ee:transform doc:name="Log" doc:id="bc2e9c7b-f08c-48a3-aabf-2d1126029a05">
                    <ee:message />
                    <ee:variables>
                        <ee:set-variable variableName="log"><![CDATA[%dw 2.0
output json
---
{
	"Endpoint": vars.attributes.requestPath,
	"Request_payload": vars.payload,
	"Response_payload": payload
}]]></ee:set-variable>
                    </ee:variables>
                </ee:transform>
                <logger level="ERROR" doc:name="Logger" doc:id="5ece523d-d6ee-4f79-a187-379b9ea8bd3a" message="#[%dw 2.0&#xA;output java&#xA;---&#xA;'&#xA;Trace Point - Error 500&#xA;'&#xA;++&#xA;write(vars.log,'application/json')]" />
            </on-error-propagate>
            <on-error-propagate type="APIKIT:NOT_IMPLEMENTED" doc:name="501">
                <ee:transform doc:name="Transform Message" doc:id="1056e4bf-3395-4492-8277-8a6135e7771e">
                    <ee:message>
                        <ee:set-payload><![CDATA[%dw 2.0
output json
---
{
	"code": 501,
	"correlation_id": correlationId,
	"reason": error.errorType.asString,
	"detail": error.description
}]]></ee:set-payload>
                    </ee:message>
                    <ee:variables />
                </ee:transform>
                <set-variable value="501" doc:name="httpStatus" doc:id="149c027a-8196-4e1e-8cc8-574f020d4445" variableName="httpStatus" />
                <ee:transform doc:name="Log" doc:id="e9611695-b333-4e1a-8ed5-cab31069a408">
                    <ee:message />
                    <ee:variables>
                        <ee:set-variable variableName="log"><![CDATA[%dw 2.0
output json
---
{
	"Endpoint": vars.attributes.requestPath,
	"Request_payload": vars.payload,
	"Response_payload": payload
}]]></ee:set-variable>
                    </ee:variables>
                </ee:transform>
                <logger level="ERROR" doc:name="Logger" doc:id="c6f3c69d-13c3-44f0-bb4a-ff4e5dcc6d26" message="#[%dw 2.0&#xA;output java&#xA;---&#xA;'&#xA;Trace Point - Error 500&#xA;'&#xA;++&#xA;write(vars.log,'application/json')]" />
            </on-error-propagate>

        </error-handler>
 
	<error-handler name="SubFlow_Error_Handler">
			<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="5f8a77d8-8530-4d1c-abfc-1f1cb43868e8" >
				<ee:transform doc:name="Transform Message" doc:id="87c60642-9f6b-4735-b165-ed6d818f5403" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
//para o content lenght vir igual a 0
if (error.suppressedErrors[0].errorMessage.attributes.headers[2] == "0")
{
    "code": error.suppressedErrors[0].errorMessage.attributes.statusCode,
    "correlation_id" : correlationId,
    "reason": error.errorType.parentErrorType.identifier,
    "detail": error.description,
    "response": null
}
else if (error.suppressedErrors !=null and error.suppressedErrors != [])
    {
        "code": error.suppressedErrors[0].muleMessage.typedAttributes.statusCode default 500,
        "correlation_id" : correlationId,
        "reason": error.suppressedErrors[0].muleMessage.typedAttributes.reasonPhrase,
        "detail": error.suppressedErrors[0].cause.localizedMessage,
        "response": error.suppressedErrors[0].muleMessage.payload
    }
else if (error.errorMessage.attributes.headers."content-length" != "0")
        {
            "code": (if (error.errorMessage.typedAttributes.statusCode == null) error.errorMessage.attributes.statusCode else error.errorMessage.typedAttributes.statusCode) default 500,
            "correlation_id" : correlationId,
            "reason": if (error.errorType.asString == null) error.errorMessage.attributes.reasonPhrase else error.errorType.asString,
            "detail": error.description,
            "response": error.errorMessage.payload
        }              
else
//para o content lenght vir igual a 0
    {
        "code": error.muleMessage.typedAttributes.statusCode ,
        "correlation_id" : correlationId,
        "reason": error.muleMessage.typedAttributes.reasonPhrase,
        "detail": error.description,
        "response": null
    }]]></ee:set-payload>
					</ee:message>
				</ee:transform>
				<set-variable value="#[payload.code]" doc:name="httpStatus" doc:id="e7e9add4-c56a-4e68-ad0b-2d3ca07dbfa2" variableName="httpStatus" />
				<logger level="ERROR" doc:name="Logger" doc:id="63bd75a3-f1f3-4cdc-9637-e43989d10c28" message="#[output application/java&#10;---&#10;'&#10;Trace Point - ERROR - ' &#10;++ write(vars.attributes.requestPath,'application/json') ++ '&#10;'&#10;++&#10;write(payload,'application/json')]" />
			</on-error-propagate>
		</error-handler>
   
	
	</mule>